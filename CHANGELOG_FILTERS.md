# Changelog - Фильтрация убийств боссов

## Дата: 2025-11-23

### Добавлено

#### Модели базы данных
- **db/models/Loot.model.js**: Добавлены поля `dungeon_filter` и `boss_filter` для хранения фильтров

#### Репозиторий
- **db/repositories/LootRepository.js**:
  - `setDungeonFilter(id, dungeonIds)` - установка фильтра подземелий
  - `setBossFilter(id, bossIds)` - установка фильтра боссов
  - `clearFilters(id)` - очистка всех фильтров

#### Сервисы
- **db/services/LootService.js**:
  - `setDungeonFilter(guildId, dungeonIds)` - установка фильтра подземелий для гильдии
  - `setBossFilter(guildId, bossIds)` - установка фильтра боссов для гильдии
  - `clearFilters(guildId)` - очистка фильтров для гильдии

#### База данных
- **db/database.js**: Экспорт новых методов для работы с фильтрами

#### Discord команды
- **discord/commands/setDungeonFilter.js** - команда `/setdungeonfilter` для установки фильтра подземелий
- **discord/commands/setBossFilter.js** - команда `/setbossfilter` для установки фильтра боссов
- **discord/commands/clearFilters.js** - команда `/clearfilters` для очистки всех фильтров

#### Документация
- **FILTERS_DOCUMENTATION.md** - полная документация по использованию фильтров
- **discord/commands/README.md** - обновлена документация команд

### Изменено

#### Логика обработки лута
- **loot/loot.js**: 
  - Функция `entryProcess()` теперь применяет фильтры по подземельям и боссам перед обработкой записей
  - Фильтрация происходит по полям `map_id` (ID подземелья) и `boss_id` (ID босса) в записях API

### Технические детали

#### Логика фильтрации
1. Получение записей об убийствах боссов из API Sirus
2. Применение фильтрации по принципу **ИЛИ**:
   - Если установлен только фильтр подземелий: проверяется `map_id`
   - Если установлен только фильтр боссов: проверяется `boss_id`
   - Если установлены оба фильтра: запись проходит при соответствии ХОТЯ БЫ ОДНОМУ условию
3. Проверка отфильтрованных записей на новизну
4. Отправка новых записей в Discord

#### Особенности
- Фильтры работают по принципу **ИЛИ** (OR), а не **И** (AND)
- При установке только фильтра подземелий выводятся все боссы из указанных подземелий
- При установке только фильтра боссов выводятся указанные боссы из любых подземелий
- При установке обоих фильтров выводятся записи, соответствующие хотя бы одному условию
- Пустые массивы фильтров означают отсутствие фильтрации

### Примеры использования

```
/setdungeonfilter dungeon_ids:533,603,631
/setbossfilter boss_ids:36597,39166
/clearfilters
```

### Совместимость

Все изменения обратно совместимы. Существующие настройки лута будут работать без фильтров (пустые массивы по умолчанию).
