# Фильтрация лута по подземельям и боссам

## Описание

Добавлена возможность фильтрации уведомлений об убийствах боссов по подземельям и конкретным боссам.

## Новые команды Discord

### `/setdungeonfilter`
Устанавливает фильтр по ID подземелий. При установке фильтра будут отображаться убийства боссов только из указанных подземелий.

**Параметры:**
- `dungeon_ids` (обязательный) - ID подземелий через запятую

**Пример использования:**
```
/setdungeonfilter dungeon_ids:533,615
```

### `/setbossfilter`
Устанавливает фильтр по ID боссов. При установке фильтра будут отображаться убийства только указанных боссов.

**Параметры:**
- `boss_ids` (обязательный) - ID боссов через запятую

**Пример использования:**
```
/setbossfilter boss_ids:15952,15953,15954
```

### `/clearfilters`
Очищает все фильтры (подземелий и боссов). После очистки будут отображаться все убийства боссов.

**Пример использования:**
```
/clearfilters
```

## Логика работы фильтров

1. **Фильтр подземелий (`dungeon_filter`)**:
   - Если установлен, выводятся убийства боссов из указанных подземелий
   - Если не установлен (пустой массив), фильтр не применяется

2. **Фильтр боссов (`boss_filter`)**:
   - Если установлен, выводятся убийства указанных боссов
   - Если не установлен (пустой массив), фильтр не применяется
   - Работает независимо от фильтра подземелий

3. **Совместная работа фильтров (логика ИЛИ)**:
   - Если установлен только фильтр подземелий: выводятся все боссы из указанных подземелий
   - Если установлен только фильтр боссов: выводятся только указанные боссы из любых подземелий
   - **Если установлены оба фильтра**: выводятся записи, которые соответствуют **ХОТЯ БЫ ОДНОМУ** условию:
     - ИЛИ босс из указанных подземелий
     - ИЛИ указанный босс из любого подземелья

## Примеры ID

### Популярные подземелья (map_id):
- **533** - Наксрамас
- **615** - Обсидиановое святилище (Сартарион)
- **616** - Око Вечности (Малигос)
- **624** - Хранилище Аркавона
- **603** - Ульдуар
- **649** - Испытание крестоносца
- **631** - Цитадель Ледяной Короны
- **724** - Рубиновое святилище

### Примеры ID боссов:
- **15952** - Аркавон Страж Камня
- **15953** - Эмалон Страж Бури
- **16028** - Лорд Джараксус
- **36597** - Лич Кинг (10N)
- **39166** - Лич Кинг (25N)

## Изменения в базе данных

### Модель `Loot`
Добавлены новые поля:
```javascript
dungeon_filter: {
  type: [Number],
  default: [],
  index: true,
}
boss_filter: {
  type: [Number],
  default: [],
  index: true,
}
```

### Новые методы API

**LootRepository:**
- `setDungeonFilter(id, dungeonIds)` - установить фильтр подземелий
- `setBossFilter(id, bossIds)` - установить фильтр боссов
- `clearFilters(id)` - очистить все фильтры

**LootService:**
- `setDungeonFilter(guildId, dungeonIds)` - установить фильтр подземелий для гильдии
- `setBossFilter(guildId, bossIds)` - установить фильтр боссов для гильдии
- `clearFilters(guildId)` - очистить все фильтры для гильдии

**database.js:**
- `setDungeonFilter(guildId, dungeonIds)`
- `setBossFilter(guildId, bossIds)`
- `clearFilters(guildId)`

## Примеры использования

### Пример 1: Фильтрация только по Наксрамасу
```
/setdungeonfilter dungeon_ids:533
```
Результат: будут выводиться все убийства боссов из Наксрамаса

### Пример 2: Фильтрация по нескольким подземельям
```
/setdungeonfilter dungeon_ids:533,603,631
```
Результат: убийства боссов из Наксрамаса, Ульдуара и Цитадели Ледяной Короны

### Пример 3: Фильтрация по конкретным боссам
```
/setbossfilter boss_ids:36597,39166
```
Результат: только убийства Лич Кинга (10N и 25N)

### Пример 4: Комбинированная фильтрация (логика ИЛИ)
```
/setdungeonfilter dungeon_ids:631
/setbossfilter boss_ids:15952,15953
```
Результат: 
- Все боссы из Цитадели Ледяной Короны (631)
- ИЛИ Аркавон и Эмалон из Хранилища Аркавона (624) - потому что они указаны в фильтре боссов

То есть выводятся записи, соответствующие ХОТЯ БЫ ОДНОМУ условию

### Пример 5: Сброс фильтров
```
/clearfilters
```
Результат: выводятся все убийства боссов без фильтрации

## Технические детали

Фильтрация происходит в функции `entryProcess` модуля `loot/loot.js`:
1. Получаются записи об убийствах боссов из API Sirus
2. Применяется фильтрация по принципу ИЛИ:
   - Если установлены оба фильтра: запись проходит, если соответствует хотя бы одному условию
   - Если установлен один фильтр: запись проходит, если соответствует этому условию
3. Отфильтрованные записи проверяются на новизну и отправляются в Discord

Фильтры работают на основе полей `map_id` (ID подземелья) и `boss_id` (ID босса) в объектах записей, получаемых из API.
